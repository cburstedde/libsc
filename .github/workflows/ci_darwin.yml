name: CI for Autotools/Darwin

on:
  push:
    paths:
      - "**/CMakeLists.txt"
      - "**.cmake"
      - "**.cmake.in"
      - "**.c"
      - "**.h"
      - "**.h.in"
      - ".github/workflows/ci_darwin.yml"
  pull_request:

jobs:
  darwin:
    runs-on: macos-latest
    name: Autotools build on Darwin
    timeout-minutes: 20
    env:
      HOMEBREW_NO_INSTALL_CLEANUP: 1

    steps:
     - run: echo "This job is running on a ${{ runner.os }} server hosted by GitHub"

     - uses: actions/checkout@v2
       name: Checkout source code

     - name: Install system dependencies
       run: brew install open-mpi ninja automake

     - name: Run bootstrap script
       run: ./bootstrap

     - name: Make check with only debug
       shell: bash
       run: |
          DIR="checkDebug" && mkdir -p "$DIR" && cd "$DIR"
          ../configure --enable-debug CFLAGS="-O0 -g -Wall -Wextra -Wno-unused-parameter"
          make -j check V=0
          cd ..

     - name: Make check with debug and MPI
       shell: bash
       run: |
          DIR="checkDebug" && mkdir -p "$DIR" && cd "$DIR"
          ../configure --enable-debug --enable-mpi CFLAGS="-O0 -g -Wall -Wextra -Wno-unused-parameter"
          make -j check V=0
          cd ..

     - name: Make check with debug, MPI and C++ compiler
       shell: bash
       run: |
          DIR="checkDebug" && mkdir -p "$DIR" && cd "$DIR"
          ../configure --enable-debug --enable-mpi CC=mpicxx CFLAGS="-O0 -g -Wall -Wextra -Wno-unused-parameter"
          make -j check V=0
          cd ..

     - name: Upload config.log on configure script failure
       if: ${{ failure() }}
       uses: actions/upload-artifact@v1
       with:
         name: configure log
         path: ./checkDebug/config.log

     - name: Check if test-suite.log exists
       id: check_test_log
       uses: andstor/file-existence-action@v1
       with:
         files: "./checkDebug/test-suite.log"   

     - name: Upload test-suite.log on test failure
       if: ${{ failure() && (steps.check_test_log.outputs.files_exists == 'true') }}
       uses: actions/upload-artifact@v1
       with:
         name: test-suite log
         path: ./checkDebug/test-suite.log