name: CI for testing autotools build on CMake tarball

env:
  CMAKE_BUILD_TYPE: Release

on:
  push:
    paths:
      - "**/CMakeLists.txt"
      - "**.cmake"
      - "**.cmake.in"
      - "**.c"
      - "**.h"
      - "**.h.in"
      - ".github/workflows/ci_cmake_tarball.yml"
  pull_request:
  release:
    types: [published]

jobs:

  linux:
    runs-on: ubuntu-latest
    name: CMake build on Linux
    timeout-minutes: 15

    strategy:
      matrix:
        cc: [clang-7, clang-8, clang-9, clang-10, gcc-7, gcc-8, gcc-9, gcc-10, gcc-11]
        shared: [true, false]

    env:
      CC: ${{ matrix.cc }}

    steps:
    - uses: actions/checkout@v2
      name: Checkout source code

    - name: Install system dependencies
      run: |
          sudo apt-get update -yq
          sudo apt-get install -yq --no-install-recommends \
              zlib1g-dev libmpich-dev mpich \
              ${{ matrix.cc }}

    - name: CMake configure and build
      shell: bash
      run: |
        DIR="cmake_build" && mkdir -p "$DIR" && cd "$DIR"
        cmake ..
        cmake --build .
        cpack --config CPackSourceConfig.cmake
        cd ./package
        TARBALL=$(find . -maxdepth 1 -name "*.tar.gz")
        tar -xzf $TARBALL
        EXTRACT=${TARBALL/%.tar.gz}
        cd $EXTRACT
        ./bootstrap
        CFLAGS="CFLAGS='-O2 -Wall -Wno-unused-parameter'"
        eval "../$NAME/configure $CFLAGS" --enable-mpi --without-blas --enable-memalign --disable-shared
        make check -j10 V=0
        ls

        